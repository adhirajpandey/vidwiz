VidWiz "Wiz" Feature Specifications
Product Requirements Document (PRD)
1. Vision and Objective
Wiz provides a dedicated, AI-powered workspace for mastering a single YouTube video through grounded chat. The assistant is strictly limited to the video transcript and metadata, turning passive watching into active learning with precise, time-linked answers.

2. Access, Persistence, and Quotas
Authenticated Users:
- Persistent chat history across sessions.
- Quota is enforced server-side; no real-time counter is shown in the UI.
- On limit hit, chat becomes read-only and a dismissible upgrade prompt appears.

Guest Users:
- Trial-only access with daily message limits.
- Guest session identifier persists across reloads in the same browser session (sessionStorage).
- Conversations are stored in the backend for guests as well as authenticated users; there is no automatic deletion.
- Hard block after daily limit is reached for that day.
- On trial limit, chat becomes read-only and a dismissible login/signup prompt appears.

Product Config Values:
- Trial total messages per day: 5.
- Daily messages per user (initial): 20.
- Rate limit (initial): 10 requests/minute.
- Daily reset occurs at 00:00 UTC (day is always counted in UTC).

3. Navigation and Entry Points
Authenticated Entry:
- Global navbar includes a "Wiz" link.
- Video Notes page can deep-link into Wiz for that video.

Guest Entry:
- Landing page CTA introduces Wiz.
- Direct access via `/wiz`.

Dashboard Presence:
- Wiz does not appear as a dashboard area and has no recent chats list.
- Conversations are stored in the backend but are not exposed in the UI.
- Only the app owner can access stored conversations.

Entry Portal (/wiz):
- Accepts full YouTube URLs, short links, or raw video IDs.
- Supports Shorts, live, and timestamped URLs.
- Input is validated on both frontend and backend.
- Extracts the video ID and routes to the workspace.

4. Wiz Workspace Experience
Layout:
- Fixed split view: video + metadata on the left, full-height chat on the right.
- Mobile stacks the panes vertically; layout is not resizable.

Interaction Model:
- Grounded responses only; no cross-video context.
- Responses may use video metadata when available.
- Inline timestamp citations navigate the player to the cited moment.
- Timestamp citation format: [12:34] (later converted to seconds in UI).
- Multiple citations may appear in a single response.
- Video playback continues unless a timestamp is clicked.

Notes Integration:
- Wiz chat output is not saved as notes.

Player:
- Use YouTube embed.
- Do not autoplay.

Technical Requirements Document (TRD)
1. Frontend Architecture and Routing
Routes:
- `/wiz`: Entry portal for video identification.
- `/wiz/:videoId`: Dedicated workspace for a single video session.

Navigation Integration:
- Add "Wiz" to the global navbar for authenticated users.

Workspace Composition:
- Player/metadata pane + full-height chat pane in a fixed split view.
- Mobile stacks vertically; no user-resizable split.

Entry Validation:
- Accept full URLs, short links, or raw IDs.
- Support Shorts, live, and timestamped URLs.
- Reject any playlist URL with a validation error.
- Validate client-side and mirror validation rules server-side.

2. Data Models and Persistence
Conversations:
- Fields: `id`, `video_id`, `user_id` (nullable), `guest_session_id`, `created_at`, `updated_at`.
- Guest sessions persist across reloads within the same browser session (sessionStorage).
- Always start a new conversation thread per entry.

Messages:
- Fields: `id`, `conversation_id`, `role`, `content`, `created_at`.
- Persist messages for both authenticated and guest users with no automatic deletion.
- Structured metadata for inline timestamp citations, e.g.:
  - `citations`: list of `{start_seconds, end_seconds?, label}` where `label` renders as [mm:ss].

Guest Tracking:
- Use a client-generated session identifier for quota enforcement.
- Store guest messages and conversations in the backend with no automatic deletion.

3. API and Backend Integration
Chat Endpoint (POST `/api/wiz/chat`):
- Auth: JWT for authenticated users or `guest_session_id` for guests.
- Quotas: Enforce daily guest message limit (5/day), daily per-user cap (20/day), and 10 req/min rate limit.
- Reset window: 00:00 UTC (day is always counted in UTC).
- Precedence: apply the strictest limit hit and return 429 with a stable reason code.
- Context: Retrieve transcript from S3 and assemble prompt context from the single video only.
- Streaming: Server-Sent Events (SSE) required on day one.
- Transcript Gating: If transcript missing, return 202 with `{status: "processing"}` and do not create a conversation or accept messages.
- Async Fallback: Trigger existing transcript/metadata fetch jobs when missing.
- Frontend shows stepped states (fetching → processing → thinking) when transcript is unavailable; if stuck >30s, prompt user to retry.
- Poll transcript readiness every 5s for up to 30s, then offer manual retry.

4. Infrastructure and Security
Storage:
- Use existing S3 utilities for transcript retrieval.
Access Control:
- Stored conversations are not exposed in the UI; access is restricted to the app owner.

Rate Limiting:
- Enforce per-IP rate limits plus guest quotas (session_id + IP) and authenticated quotas (user + IP).
- For shared IPs, per-user limits still apply; per-IP limits are a safety net, not the primary guardrail.

LLM Guardrails:
- System prompt enforces transcript-only grounding and inline timestamp formatting.
- If asked outside transcript scope, respond with a refusal and invite a transcript-relevant query.
- Do not start a chat session until a transcript is available.