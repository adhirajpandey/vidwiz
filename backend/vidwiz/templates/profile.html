<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Profile - VidWiz</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <style>
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 24px;
        border-radius: 4px;
        color: white;
        font-size: 14px;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        z-index: 1000;
      }
      .toast.show { opacity: 1; }
      .toast.success { background-color: #10B981; }
      .toast.error { background-color: #EF4444; }
      .toast.info { background-color: #3B82F6; }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      .modal.show { display: flex; }
    </style>
  </head>
  <body class="bg-gray-100">
    <div id="toast" class="toast"></div>
    <div id="revokeModal" class="modal">
      <div class="bg-white rounded-lg p-3 md:p-6 max-w-sm w-full mx-4">
        <div class="text-center">
          <div class="text-red-500 text-2xl md:text-3xl mb-3 md:mb-4">
            <svg class="w-8 h-8 mx-auto" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
            </svg>
          </div>
          <h3 class="text-base md:text-lg font-semibold text-gray-800 mb-2 md:mb-3">Revoke API Token</h3>
          <p class="text-sm md:text-base text-gray-700 mb-4 md:mb-6">Are you sure you want to revoke your API token? This action cannot be undone and will immediately invalidate the token. Any applications using this token will stop working.</p>
          <div class="flex justify-center space-x-2 md:space-x-4">
            <button id="cancelRevoke" class="px-2 md:px-3 py-1 md:py-1.5 text-xs md:text-sm font-medium text-white bg-gray-600 rounded-md hover:bg-gray-700 transition-colors">
              Cancel
            </button>
            <button id="confirmRevoke" class="px-2 md:px-3 py-1 md:py-1.5 text-xs md:text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors">
              Revoke Token
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="fixed top-0 left-0 w-full z-50 bg-red-600">
      <div class="mx-auto max-w md:max-w-7xl px-2 md:px-6">
        <div class="relative flex h-16 justify-between items-center">
          <div class="flex flex-1 items-stretch justify-start">
            <a href="/dashboard">
              <div class="text-3xl m-2 font-extrabold text-center text-white">
                VidWiz Profile
              </div>
            </a>
          </div>
          <!-- Profile Icon Dropdown -->
          <div class="flex items-center">
            <div class="relative group">
              <button id="profile-btn" class="flex items-center justify-center w-10 h-10 rounded-full bg-white hover:bg-gray-200 focus:outline-none">
                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="8" r="4" />
                  <path d="M6 20c0-2.2 3.6-3.4 6-3.4s6 1.2 6 3.4" />
                </svg>
              </button>
              <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-2 z-50 border border-gray-200">
                <div class="px-4 py-2 text-gray-600 text-sm font-medium bg-gray-50 border-b border-gray-200" id="profile-username">Username</div>
                <a href="/profile" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 text-sm">Profile</a>
                <button id="logout-btn" class="w-full text-left px-4 py-2 text-red-600 hover:bg-gray-100 text-sm">Logout</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="max-w-2xl mx-auto mt-20 p-2 md:p-4">
      <!-- Profile Settings Card -->
      <div class="bg-white rounded-lg shadow-md p-3 md:p-6 mb-4 md:mb-6">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Profile Settings</h2>
        
        <!-- Username Section -->
        <div class="mb-6">
          <label class="block text-gray-700 mb-2 font-medium" for="username">Username</label>
          <input 
            class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-500 cursor-not-allowed" 
            type="text" 
            id="username" 
            name="username" 
            readonly 
            disabled
            placeholder="Loading..."
          />
        </div>

        <!-- LLM Note Settings Section -->
        <div class="mb-6">
          <label class="block text-gray-700 mb-3 font-medium">LLM Note Generation</label>
          <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg bg-gray-50">
            <div>
              <h3 class="text-sm font-medium text-gray-800">Auto-generate AI notes</h3>
              <p class="text-xs text-gray-600">Automatically generate notes based on video timestamp content using AI</p>
            </div>
            <div class="relative">
              <input 
                type="checkbox" 
                id="llm-notes-toggle" 
                class="sr-only"
              />
              <label 
                for="llm-notes-toggle" 
                class="flex items-center cursor-pointer"
              >
                <div class="relative">
                  <div class="block bg-gray-300 w-14 h-8 rounded-full transition-colors duration-200 ease-in-out"></div>
                  <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition-transform duration-200 ease-in-out"></div>
                </div>
              </label>
            </div>
          </div>
        </div>

        <!-- API Token Section -->
        <div class="mb-6">
          <label class="block text-gray-700 mb-3 font-medium">API Access</label>
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="flex items-center justify-between mb-3">
              <div>
                <h3 class="text-sm font-medium text-gray-800">Long-term API Token</h3>
                <p class="text-xs text-gray-600">Generate a token for API access to your VidWiz account</p>
              </div>
            </div>
            
            <!-- Current Token Display -->
            <div id="current-token-section" class="mb-4 hidden">
              <label class="block text-xs text-gray-600 mb-1">Current Token:</label>
              <div class="flex items-center space-x-2">
                <input 
                  type="password" 
                  id="current-token" 
                  class="flex-1 px-3 py-2 text-xs border border-gray-300 rounded bg-gray-50 font-mono"
                  readonly
                  placeholder="••••••••••••••••••••••••••••••••"
                />
                <button 
                  id="toggle-token-visibility" 
                  class="px-3 py-2 text-xs bg-gray-200 hover:bg-gray-300 rounded transition-colors"
                  type="button"
                >
                  Show
                </button>
                <button 
                  id="copy-token-btn" 
                  class="px-3 py-2 text-xs bg-red-600 hover:bg-red-700 text-white rounded transition-colors"
                  type="button"
                >
                  Copy
                </button>
              </div>
            </div>

            <!-- No Token Message -->
            <div id="no-token-section" class="mb-4">
              <p class="text-sm text-gray-600">No API token generated yet.</p>
            </div>

            <!-- Action Buttons -->
            <div class="flex space-x-2">
              <button 
                id="generate-token-btn" 
                class="px-4 py-2 text-sm bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                type="button"
              >
                <span id="generate-btn-text">Generate Token</span>
                <span id="generate-btn-loading" class="hidden">
                  <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  Generating...
                </span>
              </button>
              <button 
                id="revoke-token-btn" 
                class="px-4 py-2 text-sm bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors hidden disabled:opacity-50 disabled:cursor-not-allowed"
                type="button"
              >
                <span id="revoke-btn-text">Revoke Token</span>
                <span id="revoke-btn-loading" class="hidden">
                  <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  Revoking...
                </span>
              </button>
            </div>
            
            <!-- Token Generation Warning -->
            <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-800">
              <strong>Long-term API Token:</strong> This token never expires and provides full access to your account. Only one token can exist at a time. Keep it secure and revoke immediately if compromised. You must revoke your existing token before generating a new one.
            </div>
          </div>
        </div>

        <!-- Back to Dashboard Button -->
        <div class="flex justify-start">
          <a 
            href="/dashboard" 
            class="inline-flex items-center px-4 py-2 text-sm bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors"
          >
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back to Dashboard
          </a>
        </div>
      </div>
    </div>

  </body>
  <script>
    const token = localStorage.getItem("vidwiz-token");
    if (!token) {
      window.location.href = "/login";
    }

    // Parse JWT to extract user info
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) { 
        return {}; 
      }
    }

    // Show a toast notification (consistent with video.html)
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => toast.className = 'toast', 3000);
    }

    // Initialize page with user data
    async function initializePage() {
      const jwtToken = localStorage.getItem("vidwiz-token");
      if (jwtToken) {
        const payload = parseJwt(jwtToken);
        
        // Set username in both places
        const username = payload.username || `User #${payload.user_id}` || 'Unknown User';
        document.getElementById("username").value = username;
        document.getElementById("profile-username").textContent = username;
      }

      // Load profile data from backend
      await loadProfileData();
    }

    // Load profile data from backend
    async function loadProfileData() {
      try {
        const token = localStorage.getItem("vidwiz-token");
        const response = await fetch('/user/profile', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const profileData = await response.json();
          
          // Update AI notes toggle
          updateToggleDisplay(profileData.ai_notes_enabled);
          
          // Update token section based on token existence
          updateTokenSection(profileData.token_exists ? 'hidden_token' : null);
        } else {
          console.error('Failed to load profile data');
          showToast('Failed to load profile data', 'error');
        }
      } catch (error) {
        console.error('Error loading profile data:', error);
        showToast('Error loading profile data', 'error');
      }
    }

    // Toggle functionality
    function setupToggle() {
      const toggle = document.getElementById('llm-notes-toggle');
      const toggleContainer = toggle.parentElement.querySelector('.relative > div:first-child');
      const toggleDot = toggle.parentElement.querySelector('.dot');
      
      toggle.addEventListener('change', async function() {
        const enabled = this.checked;
        updateToggleDisplay(enabled);
        
        // Send update to backend
        try {
          const token = localStorage.getItem("vidwiz-token");
          const response = await fetch('/user/profile', {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              ai_notes_enabled: enabled
            })
          });

          if (response.ok) {
            showToast(enabled ? 'AI notes enabled' : 'AI notes disabled', 'success');
          } else {
            // Revert toggle on error
            updateToggleDisplay(!enabled);
            showToast('Failed to update AI notes setting', 'error');
          }
        } catch (error) {
          // Revert toggle on error
          updateToggleDisplay(!enabled);
          showToast('Error updating AI notes setting', 'error');
        }
      });
    }

    function updateToggleDisplay(enabled) {
      const toggle = document.getElementById('llm-notes-toggle');
      const toggleContainer = toggle.parentElement.querySelector('.relative > div:first-child');
      const toggleDot = toggle.parentElement.querySelector('.dot');
      
      toggle.checked = enabled;
      
      if (enabled) {
        toggleContainer.classList.remove('bg-gray-300');
        toggleContainer.classList.add('bg-red-600');
        toggleDot.style.transform = 'translateX(1.5rem)';
      } else {
        toggleContainer.classList.remove('bg-red-600');
        toggleContainer.classList.add('bg-gray-300');
        toggleDot.style.transform = 'translateX(0)';
      }
    }

    // Token management functionality
    function setupTokenManagement() {
      const generateBtn = document.getElementById('generate-token-btn');
      const revokeBtn = document.getElementById('revoke-token-btn');
      const toggleVisibilityBtn = document.getElementById('toggle-token-visibility');
      const copyBtn = document.getElementById('copy-token-btn');
      const tokenInput = document.getElementById('current-token');

      generateBtn.addEventListener('click', async function() {
        if (this.disabled) {
          showToast('Please revoke your existing token before generating a new one', 'info');
          return;
        }
        
        setButtonLoading('generate', true);
        
        try {
          const token = localStorage.getItem("vidwiz-token");
          const response = await fetch('/user/token', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            const data = await response.json();
            updateTokenSection(data.token);
            showToast(data.message || 'API token generated successfully', 'success');
          } else {
            const errorData = await response.json();
            showToast(errorData.error || 'Failed to generate token', 'error');
          }
        } catch (error) {
          showToast('Error generating token', 'error');
        } finally {
          setButtonLoading('generate', false);
        }
      });

      revokeBtn.addEventListener('click', async function() {
        if (this.disabled) return;
        
        showRevokeConfirmation();
      });

      toggleVisibilityBtn.addEventListener('click', function() {
        if (tokenInput.type === 'password') {
          tokenInput.type = 'text';
          this.textContent = 'Hide';
        } else {
          tokenInput.type = 'password';
          this.textContent = 'Show';
        }
      });

      copyBtn.addEventListener('click', async function() {
        try {
          await navigator.clipboard.writeText(tokenInput.value);
          showToast('Token copied to clipboard', 'success');
        } catch (err) {
          // Fallback for older browsers
          tokenInput.select();
          document.execCommand('copy');
          showToast('Token copied to clipboard', 'success');
        }
      });
    }

    // Helper function to show loading states on buttons
    function setButtonLoading(buttonType, loading) {
      if (buttonType === 'generate') {
        const btn = document.getElementById('generate-token-btn');
        const text = document.getElementById('generate-btn-text');
        const loadingSpinner = document.getElementById('generate-btn-loading');
        
        if (loading) {
          btn.disabled = true;
          text.classList.add('hidden');
          loadingSpinner.classList.remove('hidden');
        } else {
          btn.disabled = false;
          text.classList.remove('hidden');
          loadingSpinner.classList.add('hidden');
        }
      } else if (buttonType === 'revoke') {
        const btn = document.getElementById('revoke-token-btn');
        const text = document.getElementById('revoke-btn-text');
        const loadingSpinner = document.getElementById('revoke-btn-loading');
        
        if (loading) {
          btn.disabled = true;
          text.classList.add('hidden');
          loadingSpinner.classList.remove('hidden');
        } else {
          btn.disabled = false;
          text.classList.remove('hidden');
          loadingSpinner.classList.add('hidden');
        }
      }
    }

    // Show revoke confirmation modal
    function showRevokeConfirmation() {
      const modal = document.getElementById('revokeModal');
      modal.classList.add('show');
      
      // Close modal when clicking outside
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.classList.remove('show');
        }
      });
      
      document.getElementById('cancelRevoke').onclick = () => {
        modal.classList.remove('show');
      };
      
      document.getElementById('confirmRevoke').onclick = async () => {
        modal.classList.remove('show');
        await performTokenRevocation();
      };
    }

    // Perform the actual token revocation
    async function performTokenRevocation() {
      setButtonLoading('revoke', true);
      
      try {
        const token = localStorage.getItem("vidwiz-token");
        const response = await fetch('/user/token', {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          updateTokenSection(null);
          showToast(data.message || 'API token revoked successfully', 'success');
        } else {
          const errorData = await response.json();
          showToast(errorData.error || 'Failed to revoke token', 'error');
        }
      } catch (error) {
        showToast('Error revoking token', 'error');
      } finally {
        setButtonLoading('revoke', false);
      }
    }

    function updateTokenSection(token) {
      const currentTokenSection = document.getElementById('current-token-section');
      const noTokenSection = document.getElementById('no-token-section');
      const tokenInput = document.getElementById('current-token');
      const revokeBtn = document.getElementById('revoke-token-btn');
      const generateBtn = document.getElementById('generate-token-btn');
      const generateBtnText = document.getElementById('generate-btn-text');

      if (token && token !== 'hidden_token') {
        // Newly generated token - show it
        tokenInput.value = token;
        tokenInput.type = 'password'; // Start hidden for security
        document.getElementById('toggle-token-visibility').textContent = 'Show';
        currentTokenSection.classList.remove('hidden');
        noTokenSection.classList.add('hidden');
        revokeBtn.classList.remove('hidden');
        generateBtnText.textContent = 'Generate New Token';
        generateBtn.disabled = true;
        generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
        generateBtn.classList.remove('hover:bg-red-700');
      } else if (token === 'hidden_token') {
        // Token exists but we don't show it
        tokenInput.value = '';
        currentTokenSection.classList.add('hidden');
        noTokenSection.classList.add('hidden');
        
        // Show message that token exists
        const existingTokenMessage = document.createElement('div');
        existingTokenMessage.id = 'existing-token-message';
        existingTokenMessage.className = 'mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800';
        existingTokenMessage.innerHTML = '<strong>Active Token:</strong> You have an active API token. You must revoke it before generating a new one. Only one long-term token can exist at a time.';
        
        // Remove any existing message
        const existingMessage = document.getElementById('existing-token-message');
        if (existingMessage) {
          existingMessage.remove();
        }
        
        // Insert before action buttons
        const actionButtons = document.querySelector('.flex.space-x-2');
        actionButtons.parentNode.insertBefore(existingTokenMessage, actionButtons);
        
        revokeBtn.classList.remove('hidden');
        generateBtnText.textContent = 'Generate New Token';
        generateBtn.disabled = true;
        generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
        generateBtn.classList.remove('hover:bg-red-700');
      } else {
        // No token
        tokenInput.value = '';
        currentTokenSection.classList.add('hidden');
        noTokenSection.classList.remove('hidden');
        revokeBtn.classList.add('hidden');
        generateBtnText.textContent = 'Generate Token';
        generateBtn.disabled = false;
        generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        generateBtn.classList.add('hover:bg-red-700');
        
        // Remove existing token message if present
        const existingMessage = document.getElementById('existing-token-message');
        if (existingMessage) {
          existingMessage.remove();
        }
      }
    }

    // Profile dropdown logic
    function setupProfileDropdown() {
      const profileBtn = document.getElementById("profile-btn");
      const profileDropdown = document.getElementById("profile-dropdown");
      
      profileBtn.addEventListener("click", function (e) {
        e.stopPropagation();
        profileDropdown.classList.toggle("hidden");
      });
      
      document.addEventListener("click", function (e) {
        if (!profileDropdown.classList.contains("hidden")) {
          profileDropdown.classList.add("hidden");
        }
      });
      
      profileDropdown.addEventListener("click", function (e) {
        e.stopPropagation();
      });
    }

    // Logout functionality
    function setupLogout() {
      document.getElementById("logout-btn").addEventListener("click", function () {
        localStorage.removeItem("vidwiz-token");
        window.location.href = "/login";
      });
    }

    // Initialize everything when page loads
    document.addEventListener("DOMContentLoaded", async function() {
      await initializePage();
      setupToggle();
      setupTokenManagement();
      setupProfileDropdown();
      setupLogout();
    });
  </script>
</html>
